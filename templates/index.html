<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Score Cropper</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- PDF.js library -->
    <script src="{{ url_for('static', filename='js/pdfjs/pdf.min.js') }}"></script>
</head>
<body>
    <nav>
        <div class="nav-container">
            <h1 class="logo">üéµ Music Score Cropper</h1>
            <ul class="nav-links">
                <li><a href="{{ url_for('index') }}">Home</a></li>
                <li><a href="{{ url_for('about') }}">About</a></li>
            </ul>
        </div>
    </nav>
    
    <main>
        <div class="container">
            <div class="hero">
                <h2>Crop PDF Score Margins</h2>
                <p>Upload your PDF music scores and automatically crop margins for better viewing on iPad and tablets.</p>
            </div>
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="alert">
                        {% for message in messages %}
                            <p>{{ message }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
            
            {% if not uploaded_filename %}
            <div class="upload-section">
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                    <div class="form-group">
                        <label for="file">Select PDF Score:</label>
                        <input type="file" id="file" name="file" accept=".pdf" required>
                    </div>
                    
                    <button type="submit" class="btn-primary">Upload & Preview</button>
                </form>
            </div>
            
            <div class="info-section">
                <h3>How it works:</h3>
                <ol>
                    <li>Upload your PDF music score</li>
                    <li>Preview the PDF and adjust margins for each side independently</li>
                    <li>See real-time crop boundaries on the preview</li>
                    <li>Click "Crop PDF" to process</li>
                    <li>Download your cropped PDF with larger notes for better viewing</li>
                </ol>
            </div>
            {% else %}
            <!-- Preview Section -->
            <div class="preview-section">
                <h3>PDF Preview</h3>
                <div class="preview-container">
                    <canvas id="pdf-canvas"></canvas>
                    <canvas id="overlay-canvas"></canvas>
                </div>
                <div class="page-controls">
                    <button id="prev-page" class="btn-secondary">‚Üê Previous</button>
                    <span id="page-info">Page <span id="page-num">1</span> of <span id="page-count">1</span></span>
                    <button id="next-page" class="btn-secondary">Next ‚Üí</button>
                </div>
            </div>
            
            <!-- Margin Controls -->
            <div class="margin-controls">
                <h3>Adjust Margins</h3>
                <form id="crop-form" action="{{ url_for('crop_pdf') }}" method="post">
                    <input type="hidden" name="filename" value="{{ uploaded_filename }}">
                    
                    <div class="margin-grid">
                        <div class="margin-control">
                            <label for="top-margin">Top Margin:</label>
                            <input type="hidden" id="top-margin" name="top" value="10">
                            <div class="margin-values">
                                <span class="margin-percent"><span id="top-value">10</span>%</span>
                                <span class="margin-points"><span id="top-points">0</span> pts</span>
                            </div>
                        </div>
                        
                        <div class="margin-control">
                            <label for="right-margin">Right Margin:</label>
                            <input type="hidden" id="right-margin" name="right" value="10">
                            <div class="margin-values">
                                <span class="margin-percent"><span id="right-value">10</span>%</span>
                                <span class="margin-points"><span id="right-points">0</span> pts</span>
                            </div>
                        </div>
                        
                        <div class="margin-control">
                            <label for="bottom-margin">Bottom Margin:</label>
                            <input type="hidden" id="bottom-margin" name="bottom" value="10">
                            <div class="margin-values">
                                <span class="margin-percent"><span id="bottom-value">10</span>%</span>
                                <span class="margin-points"><span id="bottom-points">0</span> pts</span>
                            </div>
                        </div>
                        
                        <div class="margin-control">
                            <label for="left-margin">Left Margin:</label>
                            <input type="hidden" id="left-margin" name="left" value="10">
                            <div class="margin-values">
                                <span class="margin-percent"><span id="left-value">10</span>%</span>
                                <span class="margin-points"><span id="left-points">0</span> pts</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" id="reset-margins" class="btn-secondary">Reset to Default</button>
                        <button type="submit" class="btn-primary">Crop PDF</button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </main>
    
    <footer>
        <p>&copy; 2024 Music Score Cropper | Built for musicians</p>
    </footer>
    
    {% if uploaded_filename %}
    <script>
        // PDF.js configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = "{{ url_for('static', filename='js/pdfjs/pdf.worker.min.js') }}";
        
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;
        let pdfCanvas = document.getElementById('pdf-canvas');
        let overlayCanvas = document.getElementById('overlay-canvas');
        let ctx = pdfCanvas.getContext('2d');
        let overlayCtx = overlayCanvas.getContext('2d');
        let currentPageDimensions = { width: 0, height: 0 };
        
        // Load PDF
        const pdfUrl = {{ url_for('preview_pdf', filename=uploaded_filename) | tojson }};
        
        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
            pdfDoc = pdf;
            document.getElementById('page-count').textContent = pdf.numPages;
            renderPage(pageNum);
        });
        
        function renderPage(num) {
            pageRendering = true;
            
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale: scale });
                
                // Store page dimensions for overlay
                currentPageDimensions.width = viewport.width;
                currentPageDimensions.height = viewport.height;
                
                pdfCanvas.height = viewport.height;
                pdfCanvas.width = viewport.width;
                overlayCanvas.height = viewport.height;
                overlayCanvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                    
                    // Draw initial overlay
                    drawOverlay();
                });
            });
            
            document.getElementById('page-num').textContent = num;
        }
        
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }
        
        function onPrevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }
        
        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }
        
        document.getElementById('prev-page').addEventListener('click', onPrevPage);
        document.getElementById('next-page').addEventListener('click', onNextPage);
        
        // Margin controls
        const margins = {
            top: document.getElementById('top-margin'),
            right: document.getElementById('right-margin'),
            bottom: document.getElementById('bottom-margin'),
            left: document.getElementById('left-margin')
        };
        
        const marginValues = {
            top: document.getElementById('top-value'),
            right: document.getElementById('right-value'),
            bottom: document.getElementById('bottom-value'),
            left: document.getElementById('left-value')
        };
        
        const marginPoints = {
            top: document.getElementById('top-points'),
            right: document.getElementById('right-points'),
            bottom: document.getElementById('bottom-points'),
            left: document.getElementById('left-points')
        };
        
        function updateMarginDisplay(side) {
            const value = parseFloat(margins[side].value);
            marginValues[side].textContent = value.toFixed(1);
            
            // Calculate points (PDF points, 1/72 inch)
            // Note: This is an approximation based on the rendered canvas dimensions
            // divided by the scale factor. Actual PDF internal coordinates may vary.
            let points = 0;
            if (side === 'top' || side === 'bottom') {
                points = (currentPageDimensions.height / scale) * (value / 100);
            } else {
                points = (currentPageDimensions.width / scale) * (value / 100);
            }
            marginPoints[side].textContent = Math.round(points);
            
            drawOverlay();
        }
        
        // Dragging state
        let isDragging = false;
        let dragSide = null;
        const dragThreshold = 10; // pixels

        // Overlay canvas interaction
        overlayCanvas.addEventListener('mousedown', function(e) {
            const rect = overlayCanvas.getBoundingClientRect();
            // Calculate scale in case display size differs from internal size
            const scaleX = overlayCanvas.width / rect.width;
            const scaleY = overlayCanvas.height / rect.height;

            // Mouse coordinates in canvas units
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            // Get current crop lines
            const topPercent = parseFloat(margins.top.value) / 100;
            const rightPercent = parseFloat(margins.right.value) / 100;
            const bottomPercent = parseFloat(margins.bottom.value) / 100;
            const leftPercent = parseFloat(margins.left.value) / 100;

            const cropLeft = overlayCanvas.width * leftPercent;
            const cropRight = overlayCanvas.width * (1 - rightPercent);
            const cropTop = overlayCanvas.height * topPercent;
            const cropBottom = overlayCanvas.height * (1 - bottomPercent);

            // Check closeness to lines (using threshold scaled to canvas units)
            // Note: We're comparing canvas units directly, so threshold effectively scales with canvas resolution
            // Ideally we want screen pixel threshold.
            const thresholdX = dragThreshold * scaleX;
            const thresholdY = dragThreshold * scaleY;

            if (Math.abs(mouseY - cropTop) < thresholdY) {
                isDragging = true;
                dragSide = 'top';
            } else if (Math.abs(mouseY - cropBottom) < thresholdY) {
                isDragging = true;
                dragSide = 'bottom';
            } else if (Math.abs(mouseX - cropLeft) < thresholdX) {
                isDragging = true;
                dragSide = 'left';
            } else if (Math.abs(mouseX - cropRight) < thresholdX) {
                isDragging = true;
                dragSide = 'right';
            }
        });

        overlayCanvas.addEventListener('mousemove', function(e) {
            const rect = overlayCanvas.getBoundingClientRect();
            const scaleX = overlayCanvas.width / rect.width;
            const scaleY = overlayCanvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;
            const thresholdX = dragThreshold * scaleX;
            const thresholdY = dragThreshold * scaleY;

            if (isDragging) {
                let newValue;
                // Limit max margin to 50%
                const limit = 50;

                if (dragSide === 'top') {
                    newValue = (mouseY / overlayCanvas.height) * 100;
                    newValue = Math.max(0, Math.min(newValue, limit));
                    // Ensure top doesn't cross bottom
                    if (newValue < (100 - parseFloat(margins.bottom.value))) {
                         margins.top.value = newValue;
                    }
                } else if (dragSide === 'bottom') {
                    newValue = (1 - (mouseY / overlayCanvas.height)) * 100;
                    newValue = Math.max(0, Math.min(newValue, limit));
                     if (newValue < (100 - parseFloat(margins.top.value))) {
                        margins.bottom.value = newValue;
                    }
                } else if (dragSide === 'left') {
                    newValue = (mouseX / overlayCanvas.width) * 100;
                    newValue = Math.max(0, Math.min(newValue, limit));
                    if (newValue < (100 - parseFloat(margins.right.value))) {
                        margins.left.value = newValue;
                    }
                } else if (dragSide === 'right') {
                    newValue = (1 - (mouseX / overlayCanvas.width)) * 100;
                    newValue = Math.max(0, Math.min(newValue, limit));
                    if (newValue < (100 - parseFloat(margins.left.value))) {
                        margins.right.value = newValue;
                    }
                }
                updateMarginDisplay(dragSide);
            } else {
                // Update cursor
                const topPercent = parseFloat(margins.top.value) / 100;
                const rightPercent = parseFloat(margins.right.value) / 100;
                const bottomPercent = parseFloat(margins.bottom.value) / 100;
                const leftPercent = parseFloat(margins.left.value) / 100;

                const cropLeft = overlayCanvas.width * leftPercent;
                const cropRight = overlayCanvas.width * (1 - rightPercent);
                const cropTop = overlayCanvas.height * topPercent;
                const cropBottom = overlayCanvas.height * (1 - bottomPercent);

                let cursor = 'default';
                if (Math.abs(mouseY - cropTop) < thresholdY) cursor = 'row-resize';
                else if (Math.abs(mouseY - cropBottom) < thresholdY) cursor = 'row-resize';
                else if (Math.abs(mouseX - cropLeft) < thresholdX) cursor = 'col-resize';
                else if (Math.abs(mouseX - cropRight) < thresholdX) cursor = 'col-resize';

                overlayCanvas.style.cursor = cursor;
            }
        });

        overlayCanvas.addEventListener('mouseup', function() {
            isDragging = false;
            dragSide = null;
        });

        overlayCanvas.addEventListener('mouseleave', function() {
            isDragging = false;
            dragSide = null;
        });
        
        function drawOverlay() {
            // Clear overlay
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // Get margin percentages
            const topPercent = parseFloat(margins.top.value) / 100;
            const rightPercent = parseFloat(margins.right.value) / 100;
            const bottomPercent = parseFloat(margins.bottom.value) / 100;
            const leftPercent = parseFloat(margins.left.value) / 100;
            
            // Calculate crop boundaries
            const cropLeft = overlayCanvas.width * leftPercent;
            const cropRight = overlayCanvas.width * (1 - rightPercent);
            const cropTop = overlayCanvas.height * topPercent;
            const cropBottom = overlayCanvas.height * (1 - bottomPercent);
            
            // Draw semi-transparent overlay on cropped areas
            overlayCtx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            
            // Top area
            overlayCtx.fillRect(0, 0, overlayCanvas.width, cropTop);
            
            // Bottom area
            overlayCtx.fillRect(0, cropBottom, overlayCanvas.width, overlayCanvas.height - cropBottom);
            
            // Left area
            overlayCtx.fillRect(0, cropTop, cropLeft, cropBottom - cropTop);
            
            // Right area
            overlayCtx.fillRect(cropRight, cropTop, overlayCanvas.width - cropRight, cropBottom - cropTop);
            
            // Draw crop boundary
            overlayCtx.strokeStyle = '#667eea';
            overlayCtx.lineWidth = 3;
            overlayCtx.setLineDash([10, 5]);
            overlayCtx.strokeRect(cropLeft, cropTop, cropRight - cropLeft, cropBottom - cropTop);
            
            // Draw corner indicators
            const cornerSize = 20;
            overlayCtx.strokeStyle = '#764ba2';
            overlayCtx.lineWidth = 4;
            overlayCtx.setLineDash([]);
            
            // Top-left corner
            overlayCtx.beginPath();
            overlayCtx.moveTo(cropLeft, cropTop + cornerSize);
            overlayCtx.lineTo(cropLeft, cropTop);
            overlayCtx.lineTo(cropLeft + cornerSize, cropTop);
            overlayCtx.stroke();
            
            // Top-right corner
            overlayCtx.beginPath();
            overlayCtx.moveTo(cropRight - cornerSize, cropTop);
            overlayCtx.lineTo(cropRight, cropTop);
            overlayCtx.lineTo(cropRight, cropTop + cornerSize);
            overlayCtx.stroke();
            
            // Bottom-left corner
            overlayCtx.beginPath();
            overlayCtx.moveTo(cropLeft, cropBottom - cornerSize);
            overlayCtx.lineTo(cropLeft, cropBottom);
            overlayCtx.lineTo(cropLeft + cornerSize, cropBottom);
            overlayCtx.stroke();
            
            // Bottom-right corner
            overlayCtx.beginPath();
            overlayCtx.moveTo(cropRight - cornerSize, cropBottom);
            overlayCtx.lineTo(cropRight, cropBottom);
            overlayCtx.lineTo(cropRight, cropBottom - cornerSize);
            overlayCtx.stroke();
        }
        
        // Reset margins button
        document.getElementById('reset-margins').addEventListener('click', function() {
            margins.top.value = 10;
            margins.right.value = 10;
            margins.bottom.value = 10;
            margins.left.value = 10;
            
            Object.keys(margins).forEach(side => updateMarginDisplay(side));
        });
        
        // Initialize margin displays
        Object.keys(margins).forEach(side => updateMarginDisplay(side));
    </script>
    {% endif %}
</body>
</html>
